<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Wongnai Review Classification &mdash; pythainlp-tutorials thai2plot-18-g321b53d documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/nbsphinx-code-cells.css" type="text/css" />
      <link rel="stylesheet" href="../_static/style.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/sphinx_highlight.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
        <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Thai Wiki Language Model for Text Generation" href="text_generation.html" />
    <link rel="prev" title="spaCy-PyThaiNLP" href="spaCy_PyThaiNLP_demo.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            pythainlp-tutorials
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Tutorials:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="Han-Coref.html">ü™ø Han-Coref: Thai Coreference resolution by PyThaiNLP</a></li>
<li class="toctree-l1"><a class="reference internal" href="Thai_Dependency_Parser.html">Thai Dependency Parser</a></li>
<li class="toctree-l1"><a class="reference internal" href="find_all_thai_rhyming_words.html">Find all Thai rhyming words from Thai word</a></li>
<li class="toctree-l1"><a class="reference internal" href="machine_translation.html">PyThaiNLP Translate</a></li>
<li class="toctree-l1"><a class="reference internal" href="nlpo3ipynb.html">nlpO3</a></li>
<li class="toctree-l1"><a class="reference internal" href="pythainlp_chunk.html">Thai Chunk Parser</a></li>
<li class="toctree-l1"><a class="reference internal" href="pythainlp_get_started.html">PyThaiNLP Get Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="pythainlp_wangchanberta.html">Wangchanberta</a></li>
<li class="toctree-l1"><a class="reference internal" href="sentiment_analysis.html">Wisesight Sentiment Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="spaCy_PyThaiNLP_demo.html">spaCy-PyThaiNLP</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Wongnai Review Classification</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#Oversampling">Oversampling</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fastText-Model">fastText Model</a></li>
<li class="toctree-l2"><a class="reference internal" href="#LinearSVC-Model">LinearSVC Model</a></li>
<li class="toctree-l2"><a class="reference internal" href="#ULMFit-Model">ULMFit Model</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#Finetune-Language-Model">Finetune Language Model</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Classification">Classification</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Submission">Submission</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="text_generation.html">Thai Wiki Language Model for Text Generation</a></li>
<li class="toctree-l1"><a class="reference internal" href="thai_wav2vec2_onnx.html">Thai Wav2vec2 model to ONNX model</a></li>
<li class="toctree-l1"><a class="reference internal" href="wangchanberta_getting_started_aireseach.html">WangchanBERTa: Getting Started Notebook</a></li>
<li class="toctree-l1"><a class="reference internal" href="wangchanberta_getting_started_aireseach.html#Installation">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="wangchanberta_getting_started_aireseach.html#Choose-Pretrained-Model">Choose Pretrained Model</a></li>
<li class="toctree-l1"><a class="reference internal" href="wangchanberta_getting_started_aireseach.html#Masked-Token-Prediction">Masked Token Prediction</a></li>
<li class="toctree-l1"><a class="reference internal" href="wangchanberta_getting_started_aireseach.html#Sequence-Classification">Sequence Classification</a></li>
<li class="toctree-l1"><a class="reference internal" href="wangchanberta_getting_started_aireseach.html#Token-Classification">Token Classification</a></li>
<li class="toctree-l1"><a class="reference internal" href="wangchanberta_getting_started_aireseach.html#Document-Vectors">Document Vectors</a></li>
<li class="toctree-l1"><a class="reference internal" href="word2vec_examples.html">Thai2Vec Embeddings Examples</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">pythainlp-tutorials</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Wongnai Review Classification</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/notebooks/text_classification.ipynb" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="admonition note">
<p>Interactive online version:
<span class="raw-html"><a target="_blank" href="https://mybinder.org/v2/gh/pythainlp/tutorials/master?filepath=source/notebooks/text_classification.ipynb"><img alt="Binder badge" src="https://mybinder.org/badge_logo.svg" style="vertical-align:text-bottom"></a></span>
<span class="raw-html"><a target="_blank" href="https://colab.research.google.com/github/PyThaiNLP/tutorials/blob/master/source/notebooks/text_classification.ipynb"><img alt="Google Colab badge" src="https://colab.research.google.com/assets/colab-badge.svg" style="vertical-align:text-bottom"></a></span></p>
</div>
<section id="Wongnai-Review-Classification">
<h1>Wongnai Review Classification<a class="headerlink" href="#Wongnai-Review-Classification" title="Permalink to this heading">ÔÉÅ</a></h1>
<p>We provide two benchmarks for 5-star multi-class classification of <a class="reference external" href="https://github.com/wongnai/wongnai-corpus">wongnai-corpus</a>: <a class="reference external" href="https://github.com/facebookresearch/fastText">fastText</a> and <a class="reference external" href="https://github.com/cstorm125/thai2fit">ULMFit</a>. In both cases, we first finetune the embeddings using all data. The benchmark numbers are based on the test set. Performance metric is the micro-averaged F1 by the test set of <a class="reference external" href="https://www.kaggle.com/c/wongnai-challenge-review-rating-prediction/data">Wongnai
Challenge</a>.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>model</p></th>
<th class="head"><p>micro_f1_public</p></th>
<th class="head"><p>micro_f1_private</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><strong>ULMFit</strong></p></td>
<td><p><strong>0.59313</strong></p></td>
<td><p><strong>0.60322</strong></p></td>
</tr>
<tr class="row-odd"><td><p>fastText</p></td>
<td><p>0.5145</p></td>
<td><p>0.5109</p></td>
</tr>
<tr class="row-even"><td><p>LinearSVC</p></td>
<td><p>0.5022</p></td>
<td><p>0.4976</p></td>
</tr>
<tr class="row-odd"><td><p>Kaggle Score</p></td>
<td><p>0.59139</p></td>
<td><p>0.58139</p></td>
</tr>
<tr class="row-even"><td><p><a class="reference external" href="https://github.com/ThAIKeras/bert">BERT</a></p></td>
<td><p>0.56612</p></td>
<td><p>0.57057</p></td>
</tr>
</tbody>
</table>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># #uncomment if you are running from google colab</span>
<span class="c1"># !pip install sklearn_crfsuite</span>
<span class="c1"># !pip install https://github.com/PyThaiNLP/pythainlp/archive/dev.zip</span>
<span class="c1"># !pip install fastai==1.0.45</span>
<span class="c1"># !wget https://github.com/wongnai/wongnai-corpus/raw/master/review/review_dataset.zip; unzip review_dataset.zip</span>
<span class="c1"># !mkdir wongnai_data; ls</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">ast</span> <span class="kn">import</span> <span class="n">literal_eval</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm_notebook</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">Counter</span>
<span class="kn">import</span> <span class="nn">re</span>

<span class="c1">#viz</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>

<span class="c1"># from fastai.text import *</span>
<span class="c1"># from fastai.callbacks import CSVLogger</span>

<span class="kn">from</span> <span class="nn">pythainlp</span> <span class="kn">import</span> <span class="n">word_tokenize</span>
<span class="kn">from</span> <span class="nn">pythainlp.ulmfit</span> <span class="kn">import</span> <span class="n">process_thai</span>

<span class="n">ft_data</span> <span class="o">=</span> <span class="s1">&#39;ft_data/&#39;</span>
</pre></div>
</div>
</div>
<section id="Oversampling">
<h2>Oversampling<a class="headerlink" href="#Oversampling" title="Permalink to this heading">ÔÉÅ</a></h2>
<p>We oversampled class <code class="docutils literal notranslate"><span class="pre">1</span></code> and <code class="docutils literal notranslate"><span class="pre">2</span></code> for 11 and 3 times respectively in order to balance the classes.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;w_review_train.csv&#39;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;;&quot;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>
<span class="n">train_df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;review&quot;</span><span class="p">,</span> <span class="s2">&quot;rating&quot;</span><span class="p">]</span>
<span class="n">test_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;test_file.csv&quot;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;;&quot;</span><span class="p">)</span>
<span class="n">test_df</span><span class="p">[</span><span class="s2">&quot;rating&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">all_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">test_df</span><span class="p">[</span><span class="s2">&quot;review&quot;</span><span class="p">]),</span>\
                   <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">train_df</span><span class="p">[</span><span class="s2">&quot;review&quot;</span><span class="p">])])</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train_df</span><span class="o">.</span><span class="n">rating</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span> <span class="o">/</span> <span class="n">train_df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
4    0.469282
3    0.304328
5    0.169880
2    0.046133
1    0.010377
Name: rating, dtype: float64
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">two_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">train_df</span><span class="p">[</span><span class="n">train_df</span><span class="o">.</span><span class="n">rating</span><span class="o">==</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">)])</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">one_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">train_df</span><span class="p">[</span><span class="n">train_df</span><span class="o">.</span><span class="n">rating</span><span class="o">==</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">)])</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">train_bal</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">train_df</span><span class="p">,</span><span class="n">one_df</span><span class="p">,</span><span class="n">two_df</span><span class="p">])</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">train_bal</span><span class="o">.</span><span class="n">rating</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span> <span class="o">/</span> <span class="n">train_bal</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
4    0.392365
3    0.254448
5    0.142036
2    0.115715
1    0.095436
Name: rating, dtype: float64
</pre></div></div>
</div>
</section>
<section id="fastText-Model">
<h2><a class="reference external" href="https://github.com/facebookresearch/fastText">fastText</a> Model<a class="headerlink" href="#fastText-Model" title="Permalink to this heading">ÔÉÅ</a></h2>
<p>We used embeddings pretrained on <a class="reference external" href="https://github.com/facebookresearch/fastText/blob/master/docs/pretrained-vectors.md">Thai Wikipedia Dump</a> and finetuned them using all of <code class="docutils literal notranslate"><span class="pre">wisesight-sentiment</span></code> using skipgram model. After that, we do a 5-class classification.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>model</p></th>
<th class="head"><p>micro_f1_public</p></th>
<th class="head"><p>micro_f1_private</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>fastText</p></td>
<td><p>0.5145</p></td>
<td><p>0.5109</p></td>
</tr>
</tbody>
</table>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[57]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_txts</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;train&quot;</span><span class="p">,</span> <span class="s2">&quot;train_bal&quot;</span><span class="p">,</span> <span class="s2">&quot;test&quot;</span><span class="p">]</span>
<span class="n">dfs</span> <span class="o">=</span> <span class="p">[</span><span class="n">train_df</span><span class="p">,</span> <span class="n">train_bal</span><span class="p">,</span> <span class="n">test_df</span><span class="p">]</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">dfs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">ft_lines</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">ft_lab</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;__label__</span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;rating&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="n">ft_text</span> <span class="o">=</span> <span class="n">replace_newline</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;review&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">ft_line</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">ft_lab</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">ft_text</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="n">ft_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ft_line</span><span class="p">)</span>

    <span class="n">doc</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ft_lines</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">ft_data</span><span class="si">}{</span><span class="n">df_txts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s1">.txt&#39;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">doc</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[50]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># for fasttext embedding finetuning</span>
<span class="n">ft_lines</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">all_df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
    <span class="n">ft_lab</span> <span class="o">=</span> <span class="s2">&quot;__label__0&quot;</span>
    <span class="n">ft_text</span> <span class="o">=</span> <span class="n">replace_newline</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;review&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">ft_line</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">ft_lab</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">ft_text</span><span class="si">}</span><span class="s1">&#39;</span>
    <span class="n">ft_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ft_line</span><span class="p">)</span>

<span class="n">doc</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ft_lines</span><span class="p">)</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">ft_data</span><span class="si">}</span><span class="s1">df_all.txt&#39;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">doc</span><span class="p">)</span>
<span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[51]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># finetune with all data
!/home/charin/fastText-0.1.0/fasttext skipgram \
-pretrainedVectors &#39;model/wiki.th.vec&#39; -dim 300 \
-input ft_data/df_all.txt -output &#39;model/finetuned&#39;
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Read 1M words
Number of words:  18176
Number of labels: 1
Progress: 100.0%  words/sec/thread: 24858  lr: 0.000000  loss: 1.309402  eta: 0h0m
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[80]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># train classifier
!/home/charin/fastText-0.1.0/fasttext supervised \
-input &#39;ft_data/train_bal.txt&#39; -output &#39;model/wongnai_bal&#39; \
-pretrainedVectors &#39;model/finetuned.vec&#39; -epoch 5 -dim 300 -wordNgrams 2
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Read 1M words
Number of words:  731006
Number of labels: 5
Progress: 100.0%  words/sec/thread: 391282  lr: 0.000000  loss: 0.764689  eta: 0h0m
^C
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[81]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># get prediction</span>
<span class="n">preds</span> <span class="o">=</span> <span class="o">!</span>/home/charin/fastText-0.1.0/fasttext<span class="w"> </span>predict<span class="w"> </span><span class="s1">&#39;model/wongnai_bal.bin&#39;</span><span class="w"> </span><span class="s1">&#39;ft_data/test.txt&#39;</span>
<span class="n">pred_lab</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;__&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">preds</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[82]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">submit_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;reviewID&quot;</span><span class="p">:</span> <span class="n">test_df</span><span class="o">.</span><span class="n">reviewID</span><span class="p">,</span>
                          <span class="s2">&quot;rating&quot;</span><span class="p">:</span> <span class="n">pred_lab</span><span class="p">})</span>
<span class="n">submit_df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
<span class="n">submit_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s2">&quot;submit_fastttext_bal.csv&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="LinearSVC-Model">
<h2>LinearSVC Model<a class="headerlink" href="#LinearSVC-Model" title="Permalink to this heading">ÔÉÅ</a></h2>
<p>Code for LinearSVC is initially provided by [&#64;lukkiddd](<a class="reference external" href="https://github.com/lukkiddd">https://github.com/lukkiddd</a>). <code class="docutils literal notranslate"><span class="pre">pythainlp.ulmfit.process_thai</span></code> contains text cleaning rules with the default aimed for sparse models like bag of words. It contains <code class="docutils literal notranslate"><span class="pre">pre_rules</span></code> applied before tokenization and <code class="docutils literal notranslate"><span class="pre">post_rules</span></code> applied after.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>model</p></th>
<th class="head"><p>micro_f1_public</p></th>
<th class="head"><p>micro_f1_private</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>LinearSVC</p></td>
<td><p>0.5022</p></td>
<td><p>0.4976</p></td>
</tr>
</tbody>
</table>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span> <span class="o">=</span> <span class="n">train_bal</span><span class="p">[</span><span class="s2">&quot;review&quot;</span><span class="p">],</span> <span class="n">train_bal</span><span class="p">[</span><span class="s2">&quot;rating&quot;</span><span class="p">]</span>
<span class="n">X_test</span> <span class="o">=</span> <span class="n">test_df</span><span class="p">[</span><span class="s2">&quot;review&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train_splits</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">test_splits</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tqdm_notebook</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">train_bal</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])):</span>
    <span class="n">train_splits</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">process_thai</span><span class="p">(</span><span class="n">train_bal</span><span class="p">[</span><span class="s2">&quot;review&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">])))</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tqdm_notebook</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">test_df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])):</span>
    <span class="n">test_splits</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">process_thai</span><span class="p">(</span><span class="n">test_df</span><span class="p">[</span><span class="s2">&quot;review&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">])))</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "01cf5b2e041d4ce0a482073127c67c8b", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "097725d69a834eb5bda2b6d4b6c0c1e3", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.pipeline</span> <span class="kn">import</span> <span class="n">Pipeline</span>
<span class="kn">from</span> <span class="nn">sklearn.feature_extraction.text</span> <span class="kn">import</span> <span class="n">CountVectorizer</span><span class="p">,</span> <span class="n">TfidfTransformer</span>
<span class="kn">from</span> <span class="nn">sklearn.svm</span> <span class="kn">import</span> <span class="n">LinearSVC</span>

<span class="n">text_clf</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">([</span>
    <span class="p">(</span><span class="s2">&quot;vect&quot;</span><span class="p">,</span> <span class="n">CountVectorizer</span><span class="p">(</span><span class="n">tokenizer</span><span class="o">=</span><span class="n">process_thai</span><span class="p">,</span> <span class="n">ngram_range</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">))),</span>
    <span class="p">(</span><span class="s2">&quot;tfidf&#39;, TfidfTransformer()),</span>
    <span class="p">(</span><span class="s2">&quot;clf&quot;</span><span class="p">,</span> <span class="n">LinearSVC</span><span class="p">()),</span>
<span class="p">])</span>

<span class="n">text_clf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Pipeline(memory=None,
     steps=[(&#39;vect&#39;, CountVectorizer(analyzer=&#39;word&#39;, binary=False, decode_error=&#39;strict&#39;,
        dtype=&lt;class &#39;numpy.int64&#39;&gt;, encoding=&#39;utf-8&#39;, input=&#39;content&#39;,
        lowercase=True, max_df=1.0, max_features=None, min_df=1,
        ngram_range=(1, 2), preprocessor=None, stop_words=None,
        strip...ax_iter=1000,
     multi_class=&#39;ovr&#39;, penalty=&#39;l2&#39;, random_state=None, tol=0.0001,
     verbose=0))])
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pred_lab</span> <span class="o">=</span> <span class="n">text_clf</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">OneHotEncoder</span>
<span class="n">enc</span> <span class="o">=</span> <span class="n">OneHotEncoder</span><span class="p">(</span><span class="n">handle_unknown</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
<span class="n">pred_lab</span> <span class="o">=</span> <span class="n">text_clf</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[98]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">submit_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;reviewID&quot;</span><span class="p">:</span> <span class="n">test_df</span><span class="o">.</span><span class="n">reviewID</span><span class="p">,</span>
                          <span class="s2">&quot;rating&quot;</span><span class="p">:</span> <span class="n">pred_lab</span><span class="p">})</span>
<span class="n">submit_df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
<span class="n">submit_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s2">&quot;submit_linearsvc.csv&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="ULMFit-Model">
<h2><a class="reference external" href="https://github.com/cstorm125/thai2fit">ULMFit</a> Model<a class="headerlink" href="#ULMFit-Model" title="Permalink to this heading">ÔÉÅ</a></h2>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>model</p></th>
<th class="head"><p>micro_f1_public</p></th>
<th class="head"><p>micro_f1_private</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>ULMFit</p></td>
<td><p>0.59590</p></td>
<td><p>0.59731</p></td>
</tr>
</tbody>
</table>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># #uncomment if you are running from google colab</span>
<span class="c1"># !pip install sklearn_crfsuite</span>
<span class="c1"># !pip install https://github.com/PyThaiNLP/pythainlp/archive/dev.zip</span>
<span class="c1"># !pip install fastai==1.0.45</span>
<span class="c1"># !wget https://github.com/wongnai/wongnai-corpus/raw/master/review/review_dataset.zip; unzip review_dataset.zip</span>
<span class="c1"># !mkdir wongnai_data; ls</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">ast</span> <span class="kn">import</span> <span class="n">literal_eval</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm_notebook</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">Counter</span>
<span class="kn">import</span> <span class="nn">re</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>

<span class="kn">from</span> <span class="nn">fastai.text</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">fastai.callbacks</span> <span class="kn">import</span> <span class="n">CSVLogger</span>

<span class="kn">from</span> <span class="nn">pythainlp.ulmfit</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">model_path</span> <span class="o">=</span> <span class="s2">&quot;wongnai_data/&quot;&quot;</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#process data</span>
<span class="n">train_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;w_review_train.csv&quot;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;;&quot;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>
<span class="n">train_df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;review&quot;</span><span class="p">,</span> <span class="s2">&quot;rating&quot;</span><span class="p">]</span>
<span class="n">test_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;test_file.csv&quot;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;;&quot;</span><span class="p">)</span>
<span class="n">test_df</span><span class="p">[</span><span class="s2">&quot;rating&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">all_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">test_df</span><span class="p">[</span><span class="s2">&quot;review&quot;</span><span class="p">]),</span>\
                   <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">train_df</span><span class="p">[</span><span class="s2">&quot;review&quot;</span><span class="p">])])</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">two_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">train_df</span><span class="p">[</span><span class="n">train_df</span><span class="o">.</span><span class="n">rating</span><span class="o">==</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">)])</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">one_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">train_df</span><span class="p">[</span><span class="n">train_df</span><span class="o">.</span><span class="n">rating</span><span class="o">==</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">)])</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">train_bal</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">train_df</span><span class="p">,</span> <span class="n">one_df</span><span class="p">,</span> <span class="n">two_df</span><span class="p">])</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<section id="Finetune-Language-Model">
<h3>Finetune Language Model<a class="headerlink" href="#Finetune-Language-Model" title="Permalink to this heading">ÔÉÅ</a></h3>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># tt = Tokenizer(tok_func = ThaiTokenizer, lang = &#39;th&#39;, pre_rules = pre_rules_th, post_rules=post_rules_th)</span>
<span class="c1"># processor = [TokenizeProcessor(tokenizer=tt, chunksize=10000, mark_fields=False),</span>
<span class="c1">#             NumericalizeProcessor(vocab=None, max_vocab=60000, min_freq=3)]</span>

<span class="c1"># data_lm = (TextList.from_df(all_df, model_path, cols=[&#39;review&#39;], processor=processor)</span>
<span class="c1">#     .random_split_by_pct(valid_pct = 0.01, seed = 1412)</span>
<span class="c1">#     .label_for_lm()</span>
<span class="c1">#     .databunch(bs=64))</span>
<span class="c1"># data_lm.sanity_check()</span>
<span class="c1"># data_lm.save(&#39;wongnai_lm.pkl&#39;)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data_lm</span> <span class="o">=</span> <span class="n">load_data</span><span class="p">(</span><span class="n">model_path</span><span class="p">,</span> <span class="s2">&quot;wongnai_lm.pkl&quot;</span><span class="p">)</span>
<span class="n">data_lm</span><span class="o">.</span><span class="n">sanity_check</span><span class="p">()</span>
<span class="nb">len</span><span class="p">(</span><span class="n">data_lm</span><span class="o">.</span><span class="n">train_ds</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_lm</span><span class="o">.</span><span class="n">valid_ds</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(45735, 461)
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data_lm</span><span class="o">.</span><span class="n">show_batch</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>idx</th>
      <th>text</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>‡πÑ‡∏Ç‡πà‡∏î‡∏≤‡∏ß ‡∏´‡∏°‡∏î ‡∏ã‡∏∞ ‡∏Å‡πà‡∏≠‡∏ô   ‡πÅ‡∏ï‡πà ‡πÅ‡∏Ñ‡πà   2   ‡∏≠‡∏¢‡πà‡∏≤‡∏á ‡∏Å‡∏±‡∏ö ‡∏Ç‡πâ‡∏≤‡∏ß‡∏™‡∏ß‡∏¢ ‡∏ó‡∏µ‡πà ‡πÉ‡∏´‡πâ ‡∏°‡∏≤ ‡πÉ‡∏ô ‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì ‡∏ó‡∏µ‡πà ‡∏≠‡∏¥‡πà‡∏° ‡∏û‡∏≠‡∏î‡∏µ ‡∏Å‡πá ‡πÄ‡∏ï‡πá‡∏° ‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß   ‡πÅ‡∏°‡πà‡∏Ñ‡πâ‡∏≤ ‡∏Å‡πá ‡∏≠‡∏±‡∏ò‡∏¢‡∏≤‡∏®‡∏±‡∏¢ ‡∏î‡∏µ ‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á ‡∏ß‡πà‡∏≤ ‡∏°‡∏µ ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤ ‡∏Å‡∏¥‡∏ô   \n   ‡∏≠‡∏µ‡∏Å ‡∏ö‡πà‡∏≠‡∏¢‡πÜ ‡πÅ‡∏ô‡πà ‡∏ô‡∏≠ ‡∏ô. ..   \n   ‡πÉ‡∏Ñ‡∏£ ‡∏ú‡πà‡∏≤‡∏ô ‡∏°‡∏≤ ‡πÅ‡∏ñ‡∏ß ‡∏ô‡∏µ‡πâ ‡∏•‡∏≠‡∏á ‡πÅ‡∏ß‡∏∞ ‡∏ä‡∏¥‡∏° ‡∏ô‡∏∞‡∏Ñ‡∏∞   ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö ‡∏Ñ‡∏ô ‡∏ó‡∏µ‡πà ‡∏ä‡∏≠‡∏ö ‡∏£‡∏™</td>
    </tr>
    <tr>
      <td>1</td>
      <td>‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏° ‡∏°‡∏≤‡∏Å‡∏°‡∏≤‡∏¢   ‡πÅ‡∏ï‡πà ‡∏ó‡∏µ‡πà ‡∏Å‡∏¥‡∏ô ‡πÅ‡∏•‡πâ‡∏ß ‡∏õ‡∏•‡∏∑‡πâ‡∏° ‡∏Ñ‡∏á ‡πÄ‡∏õ‡πá‡∏ô ‡πÇ‡∏Å‡πÇ‡∏Å‡πâ ‡∏õ‡∏±‡πà‡∏ô   ‡πÄ‡∏Ç‡πâ‡∏°‡∏Ç‡πâ‡∏ô   ‡πÅ‡∏•‡∏∞   topping   ‡πÄ‡∏¢‡∏≠‡∏∞ ‡∏î‡∏µ   ‡πÄ‡∏™‡∏µ‡∏¢‡∏î‡∏≤‡∏¢ ‡∏´‡∏≤ ‡∏£‡∏π‡∏õ ‡πÑ‡∏°‡πà ‡πÄ‡∏à‡∏≠   ?   xxrep   12   xxbos   ‡∏ï‡∏≠‡∏ô :   ‡∏Å‡πã‡∏ß‡∏¢‡πÄ‡∏ï‡∏µ‡πã‡∏¢‡∏ß ‡∏ö‡πâ‡∏≤‡∏ô ‡∏ö‡∏∂‡∏á   1   \n   \n   ‡∏Å‡πã‡∏ß‡∏¢‡πÄ‡∏ï‡∏µ‡πã‡∏¢‡∏ß ‡∏ö‡πâ‡∏≤‡∏ô ‡∏ö‡∏∂‡∏á</td>
    </tr>
    <tr>
      <td>2</td>
      <td>‡πÄ‡∏ô‡∏∑‡πâ‡∏≠ ‡πÄ‡∏ô‡πâ‡∏ô ‡πÜ   ‡∏î‡∏µ ‡∏≠‡πà‡∏∞   \n   ‡∏•‡∏∑‡∏° ‡∏ñ‡πà‡∏≤‡∏¢ ‡∏™‡∏∏ ‡∏Å‡∏µ‡πâ ‡∏´‡∏°‡∏π !! xxbos   ‡πÄ‡∏ä‡πâ‡∏≤ ‡∏ß‡∏±‡∏ô‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå ‡∏´‡∏¥‡∏ß ‡∏°‡∏≤‡∏Å ‡∏Ñ‡πà‡∏∞   ‡∏´‡∏≤ ‡∏≠‡∏∞‡πÑ‡∏£ ‡∏ó‡∏≤‡∏ô ‡∏Ñ‡πà‡∏≠‡∏ô‡∏Ç‡πâ‡∏≤‡∏á ‡∏¢‡∏≤‡∏Å   ‡∏ô‡∏∂‡∏Å ‡∏Ç‡∏∂‡πâ‡∏ô ‡πÑ‡∏î‡πâ ‡∏ß‡πà‡∏≤ ‡∏£‡πâ‡∏≤‡∏ô ‡∏ß‡∏≤ ‡∏ß‡∏µ ‡∏™‡∏≤‡∏Ç‡∏≤ ‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏Å‡∏≤‡∏£ ‡πÄ‡∏õ‡∏¥‡∏î ‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô ‡πÅ‡∏•‡∏∞ ‡πÄ‡∏õ‡∏¥‡∏î ‡πÅ‡∏ï‡πà‡πÄ‡∏ä‡πâ‡∏≤ ‡∏î‡πâ‡∏ß‡∏¢   ‡πÄ‡∏•‡∏¢ ‡∏°‡∏≤ ‡∏ù‡∏≤‡∏Å ‡∏ó‡πâ‡∏≠‡∏á ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà   ‡πÉ‡∏ô ‡∏ï‡∏π‡πâ ‡∏Å‡∏±‡∏ô ‡∏°‡∏µ ‡πÉ‡∏´‡πâ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‡∏´‡∏•‡∏≤‡∏¢‡∏≠‡∏¢‡πà‡∏≤‡∏á ‡πÄ‡∏•‡∏¢   ‡∏ó‡∏±‡πâ‡∏á</td>
    </tr>
    <tr>
      <td>3</td>
      <td>‡∏™‡∏î   ‡πÄ‡∏ô‡πâ‡∏ô ‡∏ß‡πà‡∏≤ ‡∏™‡∏î ‡∏°‡∏≤‡∏Å   ‡∏Å‡∏≤‡∏£ ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£   ‡∏•‡∏∏‡∏á ‡∏Å‡∏∞ ‡∏õ‡πâ‡∏≤   ‡πÅ‡∏•‡∏∞ ‡∏•‡∏π‡∏Å‡∏™‡∏≤‡∏ß ‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏£‡πâ‡∏≤‡∏ô   ‡∏û‡∏∏‡∏î ‡∏à‡∏≤ ‡∏î‡∏µ   ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£ ‡∏î‡∏µ‡∏°‡∏≤‡∏Å xxbos   ‡∏£‡∏µ ‡∏ß‡∏¥‡∏ß ‡∏ô‡∏µ‡πâ ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô ‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß   ‡∏•‡πâ‡∏ß‡∏ô ‡πÜ ‡∏Ñ‡∏£‡∏±‡∏ö   \n   ‡∏ú‡∏° ‡πÑ‡∏î‡πâ ‡πÄ‡∏´‡πá‡∏ô ‡∏Ñ‡∏ô ‡∏£‡∏µ ‡∏ß‡∏¥‡∏ß ‡∏£‡πâ‡∏≤‡∏ô ‡∏ô‡∏µ‡πâ ‡πÄ‡∏¢‡∏≠‡∏∞ ‡∏°‡∏≤‡∏Å   ‡∏≠‡∏≠‡∏Å ‡πÅ‡∏ô‡∏ß‡∏ó‡∏≤‡∏á ‡∏ö‡∏ß‡∏Å ‡∏î‡πâ‡∏ß‡∏¢ ‡∏™‡πà‡∏ß‡∏ô‡πÉ‡∏´‡∏ç‡πà   ‡πÅ‡∏•‡πâ‡∏ß ‡πÄ‡∏°‡∏∑‡πà‡∏≠ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</td>
    </tr>
    <tr>
      <td>4</td>
      <td>\n   ‡∏ö‡∏£‡∏£‡∏¢‡∏≤‡∏Å‡∏≤‡∏® ‡∏£‡πâ‡∏≤‡∏ô ‡∏à‡∏∞ ‡πÄ‡∏õ‡πá‡∏ô ‡∏£‡∏ñ‡πÄ‡∏Ç‡πá‡∏ô ‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á ‡∏Ç‡∏≤‡∏¢ ‡∏≠‡∏¢‡∏π‡πà ‡∏£‡∏¥‡∏° ‡∏ó‡∏≤‡∏á ‡πÄ‡∏•‡∏¢ ‡∏Ñ‡∏£‡∏±‡∏ö   ‡πÇ‡∏ï‡πä‡∏∞ ‡∏ô‡∏±‡πà‡∏á ‡∏°‡∏µ ‡πÑ‡∏°‡πà ‡∏°‡∏≤‡∏Å   ‡∏ï‡∏Å‡πÅ‡∏ï‡πà‡∏á ‡πÉ‡∏´‡πâ ‡∏≠‡∏≠‡∏Å ‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏ô‡∏ß ‡∏ç‡∏µ‡πà‡∏õ‡∏∏‡πà‡∏ô ‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢   ‡∏°‡∏µ ‡∏ö‡∏≤‡∏£‡πå ‡∏ô‡∏±‡πà‡∏á ‡πÇ‡∏î‡∏¢‡∏£‡∏≠‡∏ö ‡∏£‡∏ñ‡πÄ‡∏Ç‡πá‡∏ô   ‡∏ô‡∏∂‡∏Å‡∏ñ‡∏∂‡∏á ‡∏£‡πâ‡∏≤ ‡∏ô‡∏£‡∏≤ ‡πÄ‡∏°‡∏ô ‡∏ó‡∏µ‡πà ‡∏ç‡∏µ‡πà‡∏õ‡∏∏‡πà‡∏ô ‡∏≠‡∏¢‡∏π‡πà ‡∏£‡πâ‡∏≤‡∏ô ‡∏ô‡∏∂‡∏á ‡πÄ‡∏•‡∏¢   ‡∏¢‡∏∑‡∏ô ‡∏Å‡∏¥‡∏ô ‡πÇ‡∏î‡∏¢‡∏£‡∏≠‡∏ö ‡∏£‡πâ‡∏≤‡∏ô   ‡πÑ‡∏î‡πâ ‡∏ö‡∏£‡∏£‡∏¢‡∏≤‡∏Å‡∏≤‡∏® ‡∏¢‡∏¥‡πà‡∏á‡∏ô‡∏±‡∏Å   ‡∏£‡πâ‡∏≤‡∏ô ‡∏ô‡∏µ‡πâ ‡∏à‡∏∞ ‡πÄ‡∏õ‡∏¥‡∏î ‡∏Ç‡∏≤‡∏¢ ‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô</td>
    </tr>
  </tbody>
</table></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">data_lm</span><span class="o">.</span><span class="n">train_dl</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[tensor([[   8,    2,    8,  ...,  414,    8,   29],
         [  43, 3408,    8,  ...,  135,   25,  409],
         [1325,    8, 1185,  ...,   13,   18,    8],
         ...,
         [   4, 9903,    8,  ...,    8,  368,   18],
         [  27,  360,  870,  ...,  254, 3448,   34],
         [  37,   25,  174,  ...,  429,    8, 1412]], device=&#39;cuda:0&#39;),
 tensor([[    2,     8,    36,  ...,     8,    29,   193],
         [ 3408,     8,    14,  ...,    25,   409,    61],
         [    8,  1185,     8,  ...,    18,     8,    80],
         ...,
         [ 9903,     8,     4,  ...,   368,    18,     8],
         [  360,   870, 10074,  ...,  3448,    34,   258],
         [   25,   174,   456,  ...,     8,  1412,   270]], device=&#39;cuda:0&#39;)]
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">config</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">emb_sz</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">n_hid</span><span class="o">=</span><span class="mi">1550</span><span class="p">,</span> <span class="n">n_layers</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">pad_token</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">qrnn</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">tie_weights</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">out_bias</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
             <span class="n">output_p</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span> <span class="n">hidden_p</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">input_p</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">embed_p</span><span class="o">=</span><span class="mf">0.02</span><span class="p">,</span> <span class="n">weight_p</span><span class="o">=</span><span class="mf">0.15</span><span class="p">)</span>
<span class="n">trn_args</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">drop_mult</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">clip</span><span class="o">=</span><span class="mf">0.12</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="n">learn</span> <span class="o">=</span> <span class="n">language_model_learner</span><span class="p">(</span><span class="n">data_lm</span><span class="p">,</span> <span class="n">AWD_LSTM</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span> <span class="n">pretrained</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">trn_args</span><span class="p">)</span>

<span class="c1">#load pretrained models</span>
<span class="n">learn</span><span class="o">.</span><span class="n">load_pretrained</span><span class="p">(</span><span class="o">**</span><span class="n">_THWIKI_LSTM</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">learn</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="s2">&quot;‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö‡∏û‡∏µ‡πà‡∏ô‡πâ‡∏≠‡∏á‡πÄ‡∏™‡∏∑‡πâ‡∏≠ &quot;</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="n">temperature</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&#39;‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö‡∏û‡∏µ‡πà‡∏ô‡πâ‡∏≠‡∏á‡πÄ‡∏™‡∏∑‡πâ‡∏≠ ‡πÅ‡∏î‡∏á = ‡πÄ‡∏™‡∏∑‡πâ‡∏≠ ‡πÑ‡∏´‡∏° ‡πÄ‡∏™‡∏∑‡πâ‡∏≠ ‡πÅ‡∏î‡∏á &#34; ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö &#34; Mr . ‡∏Ñ‡∏ä &#34; ‡πÄ‡∏õ‡πá‡∏ô ‡∏†‡∏≤‡∏û‡∏¢‡∏ô‡∏ï‡∏£‡πå ‡πÑ‡∏ó‡∏¢ ‡∏ó‡∏µ‡πà ‡∏≠‡∏≠‡∏Å ‡∏â‡∏≤‡∏¢ ‡πÉ‡∏ô ‡∏õ‡∏µ ‡∏û.‡∏®. 2557 ‡∏Å‡∏≥‡∏Å‡∏±‡∏ö ‡πÇ‡∏î‡∏¢ ‡∏¢‡∏∏‡∏ó‡∏ò ‡πÄ‡∏•‡∏¥‡∏® ‡∏™‡∏¥ ‡∏õ‡∏õ ‡∏†‡∏≤‡∏Ñ ‡πÅ‡∏•‡∏∞ ‡∏≠‡∏≠‡∏Å ‡∏â‡∏≤‡∏¢ ‡πÉ‡∏ô ‡πÇ‡∏£‡∏á‡∏†‡∏≤‡∏û‡∏¢‡∏ô‡∏ï‡∏£‡πå ‡πÉ‡∏ô ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 3 ‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô ‡∏û.‡∏®. 2558 ‡πÇ‡∏î‡∏¢ ‡∏°‡∏µ ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤ ‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö &#34; ‡πÄ‡∏î‡πá‡∏Å ‡∏Ñ‡∏ô&#39;
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">learn</span><span class="o">.</span><span class="n">lr_find</span><span class="p">()</span>
<span class="n">learn</span><span class="o">.</span><span class="n">recorder</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
<!-- empty output --></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
LR Finder is complete, type {learner_name}.recorder.plot() to see the graph.
Min numerical gradient: 1.58E-04
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_text_classification_37_2.png" src="../_images/notebooks_text_classification_37_2.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">len</span><span class="p">(</span><span class="n">learn</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">vocab</span><span class="o">.</span><span class="n">itos</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
22562
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#train frozen</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;training frozen&quot;</span><span class="p">)</span>
<span class="n">learn</span><span class="o">.</span><span class="n">freeze_to</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="n">learn</span><span class="o">.</span><span class="n">fit_one_cycle</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">1e-3</span><span class="p">,</span> <span class="n">moms</span><span class="o">=</span><span class="p">(</span><span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
training frozen
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
Total time: 06:36 <p><table style='width:300px; margin-bottom:10px'>
  <tr>
    <th>epoch</th>
    <th>train_loss</th>
    <th>valid_loss</th>
    <th>accuracy</th>
  </tr>
  <tr>
    <th>1</th>
    <th>4.659182</th>
    <th>4.493942</th>
    <th>0.342857</th>
  </tr>
</table></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#train unfrozen</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;training unfrozen&quot;</span><span class="p">)</span>
<span class="n">learn</span><span class="o">.</span><span class="n">unfreeze</span><span class="p">()</span>
<span class="n">learn</span><span class="o">.</span><span class="n">fit_one_cycle</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mf">1e-4</span><span class="p">,</span> <span class="n">moms</span><span class="o">=</span><span class="p">(</span><span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
training unfrozen
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
Total time: 1:26:45 <p><table style='width:300px; margin-bottom:10px'>
  <tr>
    <th>epoch</th>
    <th>train_loss</th>
    <th>valid_loss</th>
    <th>accuracy</th>
  </tr>
  <tr>
    <th>1</th>
    <th>4.375606</th>
    <th>4.252919</th>
    <th>0.385714</th>
  </tr>
  <tr>
    <th>2</th>
    <th>4.165419</th>
    <th>4.013862</th>
    <th>0.371429</th>
  </tr>
  <tr>
    <th>3</th>
    <th>4.034220</th>
    <th>3.802707</th>
    <th>0.357143</th>
  </tr>
  <tr>
    <th>4</th>
    <th>3.879111</th>
    <th>3.712463</th>
    <th>0.357143</th>
  </tr>
  <tr>
    <th>5</th>
    <th>3.823682</th>
    <th>3.624331</th>
    <th>0.371429</th>
  </tr>
  <tr>
    <th>6</th>
    <th>3.784611</th>
    <th>3.580608</th>
    <th>0.371429</th>
  </tr>
  <tr>
    <th>7</th>
    <th>3.753532</th>
    <th>3.553170</th>
    <th>0.371429</th>
  </tr>
  <tr>
    <th>8</th>
    <th>3.719396</th>
    <th>3.516521</th>
    <th>0.385714</th>
  </tr>
  <tr>
    <th>9</th>
    <th>3.699165</th>
    <th>3.513339</th>
    <th>0.385714</th>
  </tr>
  <tr>
    <th>10</th>
    <th>3.696516</th>
    <th>3.512542</th>
    <th>0.385714</th>
  </tr>
</table></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">learn</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s2">&quot;wongnai_lm&quot;</span><span class="p">)</span>
<span class="n">learn</span><span class="o">.</span><span class="n">save_encoder</span><span class="p">(</span><span class="s2">&quot;wongnai_enc&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="Classification">
<h3>Classification<a class="headerlink" href="#Classification" title="Permalink to this heading">ÔÉÅ</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">test_df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>reviewID</th>
      <th>review</th>
      <th>rating</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>‡∏£‡πâ‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏≠‡∏¢‡∏π‡πà‡πÄ‡∏™‡πâ‡∏ô‡∏™‡∏±‡∏ô‡∏Å‡∏≥‡πÅ‡∏û‡∏á-‡πÅ‡∏°‡πà‡∏≠‡∏≠‡∏ô ‡πÄ‡∏•‡∏¢‡πÅ‡∏¢‡∏Å‡∏ö‡πà...</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2</td>
      <td>‡∏™‡∏±‡πà‡∏á‡πÑ‡∏õ2 ‡πÄ‡∏°‡∏ô‡∏π ‡∏Ñ‡∏∑‡∏≠‡∏°‡∏±‡∏ä‡∏â‡∏∞‡∏•‡∏≤‡πÄ‡∏ï‡πâ‡∏£‡πâ‡∏≠‡∏ô ‡∏Å‡∏±‡∏ö ‡πÑ‡∏≠‡∏®‡∏Ñ‡∏£‡∏µ‡∏°‡∏ä‡∏≤‡πÄ‡∏Ç...</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>3</td>
      <td>‡∏Ñ‡∏£‡∏±‡∏ß‡∏ß‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô  \n\n‡∏´‡∏¥‡∏ß‡∏î‡∏∂‡∏Å‡πÜ ‡∏ï‡∏£‡∏∞‡πÄ‡∏ß‡∏ô‡∏´‡∏≤‡∏£‡πâ‡∏≤‡∏ô‡∏ó‡∏≤‡∏ô ‡∏°‡∏≤‡πÄ‡∏à‡∏≠...</td>
      <td>0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>4</td>
      <td>‡∏à‡∏∞‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏à‡πâ‡∏≤‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏Å‡πá‡∏Ñ‡∏á‡πÑ‡∏°‡πà‡∏ú‡∏¥‡∏î ‡πÅ‡∏ï‡πà‡∏Å‡πá‡πÑ‡∏°‡πà‡∏Å‡∏•‡πâ‡∏≤...</td>
      <td>0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>5</td>
      <td>‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏¥‡∏î‡∏ñ‡∏∂‡∏á‡∏™‡∏•‡∏±‡∏î‡∏ú‡∏°‡∏Ñ‡∏¥‡∏î‡∏ñ‡∏∂‡∏á‡∏£‡πâ‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏£‡πâ‡∏≤‡∏ô‡πÅ‡∏£‡∏Å‡πÜ‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±...</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tt</span> <span class="o">=</span> <span class="n">Tokenizer</span><span class="p">(</span><span class="n">tok_func</span><span class="o">=</span><span class="n">ThaiTokenizer</span><span class="p">,</span> <span class="n">lang</span><span class="o">=</span><span class="s2">&quot;th&quot;</span><span class="p">,</span> <span class="n">pre_rule</span> <span class="o">=</span><span class="n">pre_rules_th</span><span class="p">,</span> <span class="n">post_rules</span><span class="o">=</span><span class="n">post_rules_th</span><span class="p">)</span>
<span class="n">processor</span> <span class="o">=</span> <span class="p">[</span><span class="n">TokenizeProcessor</span><span class="p">(</span><span class="n">tokenizer</span><span class="o">=</span><span class="n">tt</span><span class="p">,</span> <span class="n">chunksize</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span> <span class="n">mark_fields</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
            <span class="n">NumericalizeProcessor</span><span class="p">(</span><span class="n">vocab</span><span class="o">=</span><span class="n">data_lm</span><span class="o">.</span><span class="n">vocab</span><span class="p">,</span> <span class="n">max_vocab</span><span class="o">=</span><span class="mi">60000</span><span class="p">,</span> <span class="n">min_freq</span><span class="o">=</span><span class="mi">3</span><span class="p">)]</span>

<span class="n">data_cls</span> <span class="o">=</span> <span class="p">(</span><span class="n">TextList</span><span class="o">.</span><span class="n">from_df</span><span class="p">(</span><span class="n">train_bal</span><span class="p">,</span> <span class="n">model_path</span><span class="p">,</span> <span class="n">cols</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;review&quot;</span><span class="p">],</span> <span class="n">processor</span><span class="o">=</span><span class="n">processor</span><span class="p">)</span>
    <span class="o">.</span><span class="n">random_split_by_pct</span><span class="p">(</span><span class="n">valid_pct</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">,</span> <span class="n">seed</span> <span class="o">=</span> <span class="mi">1412</span><span class="p">)</span>
    <span class="o">.</span><span class="n">label_from_df</span><span class="p">(</span><span class="s2">&quot;rating&quot;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">add_test</span><span class="p">(</span><span class="n">TextList</span><span class="o">.</span><span class="n">from_df</span><span class="p">(</span><span class="n">test_df</span><span class="p">,</span> <span class="n">model_path</span><span class="p">,</span> <span class="n">cols</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;review&quot;</span><span class="p">],</span> <span class="n">processor</span><span class="o">=</span><span class="n">processor</span><span class="p">))</span>
    <span class="o">.</span><span class="n">databunch</span><span class="p">(</span><span class="n">bs</span><span class="o">=</span><span class="mi">32</span><span class="p">)</span>
    <span class="p">)</span>

<span class="n">data_cls</span><span class="o">.</span><span class="n">sanity_check</span><span class="p">()</span>
<span class="n">data_cls</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s2">&quot;wongnai_cls.pkl&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#make sure we got the right number of vocab</span>
<span class="nb">len</span><span class="p">(</span><span class="n">data_cls</span><span class="o">.</span><span class="n">vocab</span><span class="o">.</span><span class="n">itos</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_lm</span><span class="o">.</span><span class="n">vocab</span><span class="o">.</span><span class="n">itos</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(22562, 22562)
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[53]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data_cls</span><span class="o">.</span><span class="n">show_batch</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>text</th>
      <th>target</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>xxbos   ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ ‡∏Å‡πá ‡∏à‡∏∞ ‡∏û‡∏≤ ‡πÑ‡∏õ ‡∏Å‡∏¥‡∏ô ‡∏≠‡∏≤‡∏´‡∏≤‡∏£ ‡∏≠‡∏≤‡πÄ‡∏ã‡∏µ‡∏¢‡∏ô ‡∏Å‡∏±‡∏ô‡∏ó‡∏µ‡πà ‡∏£‡∏£. ‡πÄ‡∏à‡πâ‡∏≤‡∏û‡∏£‡∏∞‡∏¢‡∏≤‡∏õ‡∏≤‡∏£‡πå‡∏Ñ   ‡∏£‡∏±‡∏ä‡∏î‡∏≤‡∏†‡∏¥‡πÄ‡∏©‡∏Å ‡∏Å‡∏±‡∏ô ‡∏ö‡πâ‡∏≤‡∏á ‡∏ô‡∏∞‡∏Ñ‡∏∞   ‡πÇ‡∏î‡∏¢ ‡∏Å‡∏≤‡∏£ ‡πÑ‡∏õ ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ô‡∏µ‡πâ ‡∏Å‡πá ‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£ ‡∏ä‡∏ß‡∏ô ‡∏à‡∏≤‡∏Å ‡∏Ñ‡∏∏‡∏ì ‡∏≠‡πâ‡∏ô ‡πÄ‡∏à‡πâ‡∏≤‡πÄ‡∏î‡∏¥‡∏° ‡πÄ‡∏ä‡πà‡∏ô‡πÄ‡∏Ñ‡∏¢ ‡∏Ñ‡πà‡∏∞   ( ‡∏á‡∏≤‡∏ô ‡∏ä‡∏∏‡∏Å ‡∏à‡∏£‡∏¥‡∏á‡πÜ   xxunk )   ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö ‡∏Å‡∏≤‡∏£ ‡πÑ‡∏õ ‡∏ß‡∏±‡∏ô‡∏ô‡∏±‡πâ‡∏ô ‡πÄ‡∏£‡∏≤ ‡πÄ‡∏≠‡∏≤ ‡∏£‡∏ñ ‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß ‡πÑ‡∏õ ‡∏Ñ‡πà‡∏∞   ‡∏£‡∏ñ‡∏ï‡∏¥‡∏î ‡∏°‡∏≤‡∏Å ‡∏ñ‡∏∂‡∏á ‡∏°‡∏≤‡∏Å ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î   ‡∏Å‡∏ß‡πà‡∏≤ ‡∏à‡∏∞ ‡πÑ‡∏õ</td>
      <td>4</td>
    </tr>
    <tr>
      <td>xxbos   ‡πÄ‡∏°‡∏∑‡πà‡∏≠ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 22   ‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô   ‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏°‡∏≤ ‡∏ß‡∏á‡πÉ‡∏ô ‡πÑ‡∏î‡πâ ‡∏à‡∏±‡∏î‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°   xxmaj relax   day   xxmaj relax   night   ‡∏Ç‡∏∂‡πâ‡∏ô ‡∏ó‡∏µ‡πà   xxmaj phothalai   ‡∏ã‡∏∂‡πà‡∏á ‡πÉ‡∏ô ‡∏á‡∏≤‡∏ô ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ ‡πÑ‡∏î‡πâ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô ‡∏Ç‡∏∂‡πâ‡∏ô ‡∏à‡∏≤‡∏Å ‡∏Å‡∏≤‡∏£ ‡πÑ‡∏î‡πâ   xxmaj tasting   ‡∏õ‡∏£‡∏∞‡πÄ‡∏î‡∏¥‡∏° ‡∏´‡πâ‡∏≠‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£ ‡πÉ‡∏´‡∏°‡πà ‡∏™‡∏î ‡∏ã‡∏¥ ‡∏á‡πÜ ‡∏ó‡∏µ‡πà ‡πÄ‡∏õ‡∏¥‡∏î ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö   group   ‡∏Ç‡∏≠‡∏á</td>
      <td>4</td>
    </tr>
    <tr>
      <td>xxbos   ‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£ ‡∏Ñ‡∏ô ‡πÄ‡∏¢‡∏≠‡∏∞ ‡∏Ñ‡∏á ‡∏î‡∏π‡πÅ‡∏• ‡πÑ‡∏°‡πà ‡∏ó‡∏±‡πà‡∏ß‡∏ñ‡∏∂‡∏á   ‡∏´‡∏£‡∏∑‡∏≠ ‡∏Å‡∏≤‡∏£   xxmaj xxunk   ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á ‡∏Å‡∏≤‡∏£ ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£   ‡∏Å‡∏≤‡∏£‡∏™‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£ ‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô ‡∏Å‡∏±‡∏ö ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô ‡πÑ‡∏°‡πà ‡∏Ñ‡∏∏‡∏¢ ‡∏Å‡∏±‡∏ô   \n   \n   ‡∏Å‡∏≤‡∏£‡∏™‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£   ‡∏ú‡∏° ‡∏°‡∏≤‡∏ñ‡∏∂‡∏á ‡∏£‡πâ‡∏≤‡∏ô   16 : 43   ‡∏ô.   ‡πÇ‡∏î‡∏¢ ‡∏ú‡∏° ‡πÄ‡∏î‡∏¥‡∏ô ‡πÑ‡∏õ ‡∏ó‡∏µ‡πà   xxmaj terrace</td>
      <td>3</td>
    </tr>
    <tr>
      <td>xxbos   ‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å ‡∏Ñ‡∏ô ‡∏û‡∏π‡∏î‡∏ñ‡∏∂‡∏á ‡∏°‡∏≤‡∏Å - ‡∏°‡∏≤‡∏Å ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î   ‡∏à‡∏ô ‡∏ó‡∏ô ‡∏Å‡∏£‡∏∞‡πÅ‡∏™ ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏£‡∏á ‡∏Ç‡∏≠‡∏á   xxmaj shibuya   xxmaj shabu   ‡πÑ‡∏°‡πà‡πÑ‡∏´‡∏ß   ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ ‡∏î‡∏≤‡∏ß ‡∏à‡∏∂‡∏á ‡∏Ç‡∏≠ ‡∏ï‡∏≤‡∏°‡∏£‡∏≠‡∏¢ ‡∏Ñ‡∏∏‡∏ì ‡πÄ‡∏ö‡∏¥‡∏£‡πå‡∏î   ( xxmaj user   :   xxmaj xxunk )   ‡∏ã‡∏∂‡πà‡∏á ‡∏î‡∏≤‡∏ß ‡πÑ‡∏î‡πâ ‡∏≠‡πà‡∏≤ ‡∏ô‡∏£‡∏µ ‡∏ß‡∏¥‡∏ß ‡∏Ç‡∏≠‡∏á ‡∏Ñ‡∏∏‡∏ì ‡πÄ‡∏ö‡∏¥‡∏£‡πå‡∏î ‡πÅ‡∏•‡πâ‡∏ß ‡∏Ñ‡∏¥‡∏î ‡∏ß‡πà‡∏≤ ‡∏à‡∏∞ ‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏≤ ‡πÇ‡∏≠ ‡∏Å‡∏≤ ‡∏™‡∏°‡∏≤‡∏ó‡∏≤‡∏ô ‡πÉ‡∏´‡πâ</td>
      <td>4</td>
    </tr>
    <tr>
      <td>xxbos   ‡πÄ‡∏õ‡∏¥‡∏î ‡∏£‡∏µ ‡∏ß‡∏¥‡∏ß ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå ‡∏ô‡∏µ‡πâ   ‡∏î‡πâ‡∏ß‡∏¢ ‡∏ä‡∏≤ ‡∏ö‡∏π ‡∏ä‡∏±‡πâ‡∏ô ‡∏Å‡∏•‡∏≤‡∏á‡πÜ   \n   \n   ‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô ‡πÜ ‡∏ä‡∏≤‡∏ß ‡∏ß‡∏á‡πÉ‡∏ô ‡∏Å‡∏±‡∏ô ‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‡∏Å‡∏±‡∏ö ‡∏ú‡∏°   xxmaj pednoii   ahha   ‡∏Å‡∏±‡∏ö ‡∏£‡∏µ ‡∏ß‡∏¥‡∏ß ‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£ ‡πÉ‡∏ô ‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£   ‡∏£‡∏µ ‡∏ß‡∏¥‡∏ß ‡πÅ‡∏£‡∏Å ‡πÉ‡∏ô ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ ‡∏ú‡∏° ‡∏à‡∏∞ ‡∏°‡∏≤ ‡∏ô‡∏≥‡πÄ‡∏™‡∏ô‡∏≠ ‡∏£‡πâ‡∏≤‡∏ô ‡∏ä‡∏≤ ‡∏ö‡∏π ‡∏ó‡∏µ‡πà ‡∏°‡∏µ ‡∏™‡∏≤‡∏Ç‡∏≤ ‡πÄ‡∏¢‡∏≠‡∏∞ ‡πÑ‡∏°‡πà ‡πÅ‡∏û‡πâ ‡∏ä‡∏≤ ‡∏ö‡∏π ‡∏ô‡∏≤‡∏á‡πÉ‡∏ô</td>
      <td>2</td>
    </tr>
  </tbody>
</table></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">config</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">emb_sz</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">n_hid</span><span class="o">=</span><span class="mi">1550</span><span class="p">,</span> <span class="n">n_layers</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">pad_token</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">qrnn</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
             <span class="n">output_p</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span> <span class="n">hidden_p</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">input_p</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">embed_p</span><span class="o">=</span><span class="mf">0.02</span><span class="p">,</span> <span class="n">weight_p</span><span class="o">=</span><span class="mf">0.15</span><span class="p">)</span>
<span class="n">trn_args</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">bptt</span><span class="o">=</span><span class="mi">70</span><span class="p">,</span> <span class="n">drop_mult</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="n">learn</span> <span class="o">=</span> <span class="n">text_classifier_learner</span><span class="p">(</span><span class="n">data_cls</span><span class="p">,</span> <span class="n">AWD_LSTM</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span> <span class="n">pretrained</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">trn_args</span><span class="p">)</span>
<span class="n">learn</span><span class="o">.</span><span class="n">opt_func</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">,</span> <span class="n">betas</span><span class="o">=</span><span class="p">(</span><span class="mf">0.7</span><span class="p">,</span> <span class="mf">0.99</span><span class="p">))</span>

<span class="c1">#load pretrained finetuned model</span>
<span class="n">learn</span><span class="o">.</span><span class="n">load_encoder</span><span class="p">(</span><span class="s2">&quot;wongnai_enc&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[55]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">learn</span><span class="o">.</span><span class="n">lr_find</span><span class="p">()</span>
<span class="n">learn</span><span class="o">.</span><span class="n">recorder</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
<!-- empty output --></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
LR Finder is complete, type {learner_name}.recorder.plot() to see the graph.
Min numerical gradient: 6.31E-07
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_text_classification_48_2.png" src="../_images/notebooks_text_classification_48_2.png" />
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[57]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># #train unfrozen</span>
<span class="c1"># learn.freeze_to(-1)</span>
<span class="c1"># learn.fit_one_cycle(1, 2e-2, moms=(0.8, 0.7))</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># #gradual unfreezing</span>
<span class="c1"># learn.freeze_to(-2)</span>
<span class="c1"># learn.fit_one_cycle(1, slice(1e-2 / (2.6 ** 4), 1e-2), moms=(0.8, 0.7))</span>
<span class="c1"># learn.freeze_to(-3)</span>
<span class="c1"># learn.fit_one_cycle(1, slice(5e-3 / (2.6 ** 4), 5e-3), moms=(0.8, 0.7))</span>
<span class="c1"># learn.unfreeze()</span>
<span class="c1"># learn.fit_one_cycle(1, slice(1e-3 / (2.6 ** 4), 1e-3), moms=(0.8, 0.7))</span>
</pre></div>
</div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>epoch     train_loss  valid_loss  accuracy
1         1.187845    1.158394    0.472803
Total time: 08:20
epoch     train_loss  valid_loss  accuracy
1         0.889035    0.828990    0.629707
Total time: 08:39
epoch     train_loss  valid_loss  accuracy
1         0.760357    0.751162    0.656904
Total time: 11:40
epoch     train_loss  valid_loss  accuracy
1         0.628719    0.721673    0.669456
Total time: 18:06
</pre></div>
</div>
</section>
<section id="Submission">
<h3>Submission<a class="headerlink" href="#Submission" title="Permalink to this heading">ÔÉÅ</a></h3>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">config</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">emb_sz</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">n_hid</span><span class="o">=</span><span class="mi">1550</span><span class="p">,</span> <span class="n">n_layers</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">pad_token</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">qrnn</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
             <span class="n">output_p</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span> <span class="n">hidden_p</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">input_p</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">embed_p</span><span class="o">=</span><span class="mf">0.02</span><span class="p">,</span> <span class="n">weight_p</span><span class="o">=</span><span class="mf">0.15</span><span class="p">)</span>
<span class="n">trn_args</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">bptt</span><span class="o">=</span><span class="mi">70</span><span class="p">,</span> <span class="n">drop_mult</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="n">learn</span> <span class="o">=</span> <span class="n">text_classifier_learner</span><span class="p">(</span><span class="n">data_cls</span><span class="p">,</span> <span class="n">AWD_LSTM</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span> <span class="n">pretrained</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">trn_args</span><span class="p">)</span>
<span class="n">learn</span><span class="o">.</span><span class="n">opt_func</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">,</span> <span class="n">betas</span><span class="o">=</span><span class="p">(</span><span class="mf">0.7</span><span class="p">,</span> <span class="mf">0.99</span><span class="p">))</span>

<span class="n">learn</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;wongnai_cls&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[22]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">probs</span><span class="p">,</span><span class="n">y</span><span class="o">=</span> <span class="n">learn</span><span class="o">.</span><span class="n">get_preds</span><span class="p">(</span><span class="n">DatasetType</span><span class="o">.</span><span class="n">Test</span><span class="p">,</span> <span class="n">ordered</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[34]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">preds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">probs</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
<span class="n">Counter</span><span class="p">(</span><span class="n">preds</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[39]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">submit_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;reviewID&quot;</span><span class="p">:</span> <span class="n">test_df</span><span class="o">.</span><span class="n">reviewID</span><span class="p">,</span> <span class="s2">&quot;rating&quot;</span><span class="p">:</span> <span class="n">preds</span><span class="p">})</span>
<span class="n">submit_df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
<span class="n">submit_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s2">&quot;submit_ulmfit.csv&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="spaCy_PyThaiNLP_demo.html" class="btn btn-neutral float-left" title="spaCy-PyThaiNLP" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="text_generation.html" class="btn btn-neutral float-right" title="Thai Wiki Language Model for Text Generation" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2019, PyThaiNLP.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>